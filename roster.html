<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster – Redline Racing Alliance</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

    <header class="site-header">
      <div class="brand">
        <img src="rra_logo.png" alt="Redline Racing Alliance logo" class="logo">
        <div class="brand-text">
          <h1>Redline Racing Alliance</h1>
          <p class="tagline">NASCAR ’25 PC Racing League</p>
        </div>
      </div>

      <nav>
        <ul class="nav-list">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="schedule.html">Schedule</a></li>
          <li><a href="signup.html">Sign&nbsp;Up</a></li>
          <li><a href="roster.html">Roster</a></li>
          <li><a href="teams.html">Teams</a></li>
          <li><a href="rules.html">Rules</a></li>
          <li><a href="standings.html">Standings</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </header>
    <main class="content">
      <h2 class="page-title">Driver Roster</h2>
      <section class="card">
        <p>
              <script>
      // 1. Put your published CSV link here:
      const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSCQmkUblHh2ZelrU5bA7bh9_qcv04B8dSZdI33kYsxxwgdIciT18hU6NeLXx2WQWan07GjkZZeKg4a/pub?gid=728407482&single=true&output=csv";
                
      function showMessage(msg) {
        const wrapper = document.querySelector(".table-wrapper");
        if (wrapper) {
          wrapper.innerHTML = "<p>" + msg + "</p>";
        }
      }

      // Proper CSV parser that handles quoted fields and commas inside quotes
      function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            // Escaped quote inside quotes ("")
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++; // skip the next quote
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            result.push(current);
            current = "";
          } else {
            current += char;
          }
        }

        result.push(current);
        return result.map(c => c.trim());
      }

      async function loadRoster() {
        try {
          const response = await fetch(SHEET_CSV_URL);
          if (!response.ok) {
            showMessage("Error loading roster data (HTTP " + response.status + ").");
            return;
          }

          const csvText = await response.text();
          const lines = csvText.trim().split(/\r?\n/);

          if (lines.length < 2) {
            showMessage("No registration data found yet.");
            return;
          }

          const parsedRows = lines.map(parseCSVLine);
          const headers = parsedRows[0];
          const rows = parsedRows.slice(1);

          // Helper to find a header index by a condition
          function findIndexBy(testFn, fromEnd = false) {
            if (fromEnd) {
              for (let i = headers.length - 1; i >= 0; i--) {
                if (testFn(headers[i], i)) return i;
              }
              return -1;
            } else {
              return headers.findIndex(testFn);
            }
          }

          // DRIVER NAME: prefer roster-specific name, fall back to Steam/in-game if needed
          const rosterNameIndex = findIndexBy(h =>
            /please type your name exactly as you would like it to appear on the roster/i.test(h)
          );

          const steamNameIndex = findIndexBy(h =>
            /steam name\/in-game tag/i.test(h)
          );

          const nameIndex = rosterNameIndex !== -1 ? rosterNameIndex : steamNameIndex;

          if (nameIndex === -1) {
            showMessage("Roster error: could not find a Driver Name column. Check your sheet headers.");
            console.error("Headers:", headers);
            return;
          }

          // VERIFIED (admin column): take the LAST header that contains 'verified'
          const verifiedIndex = findIndexBy(
            (h) => /verified/i.test(h),
            true // search from end
          );

          // If we somehow don't have a Verified column, we will show everyone
          const allRows = rows;
          const verifiedRows = allRows.filter(cells => {
            if (verifiedIndex === -1) return true; // no Verified column → show all
            const value = (cells[verifiedIndex] || "").trim();
            return value.length > 0;
          });

          if (verifiedRows.length === 0) {
            showMessage("No verified drivers yet. (" + allRows.length + " total registrations found)");
            return;
          }

          // Specific number columns by header text
          const cupIndex = findIndexBy(h => /cup number/i.test(h));
          const xfinityIndex = findIndexBy(h => /xfinity number/i.test(h));
          const truckIndex = findIndexBy(h => /truck number/i.test(h));
          const arcaIndex = findIndexBy(h => /arca number/i.test(h));

          // Customs Number column – question text includes "Customs Number Registration"
          const customsNumberIndex = findIndexBy(h =>
            /customs number/i.test(h) || /customs number registration/i.test(h)
          );

          // Customs confirmation column – long "Please confirm..." text mentioning Customs series
          const customsConfirmIndex = findIndexBy(h =>
            /please confirm the following/i.test(h) &&
            /customs series/i.test(h)
          );

          // Build an array of possible series/number columns
          const seriesColumns = [
            { label: "Cup",       index: cupIndex },
            { label: "Xfinity",   index: xfinityIndex },
            { label: "Truck",     index: truckIndex },
            { label: "ARCA",      index: arcaIndex },
            { label: "Customs #", index: customsNumberIndex },
          ];

          // Keep only series columns where at least one verified driver has a value
          const activeSeriesColumns = seriesColumns.filter(col => {
            if (col.index === -1) return false;
            return verifiedRows.some(cells => {
              const value = (cells[col.index] || "").trim();
              return value.length > 0;
            });
          });

          // Filter verified rows down to only "real" rows:
          // must have a name AND at least one number OR a customs confirmation
          const displayRows = verifiedRows.filter(cells => {
            const name = (cells[nameIndex] || "").trim();

            const hasNumber = activeSeriesColumns.some(col => {
              const value = (cells[col.index] || "").trim();
              return value.length > 0;
            });

            const hasCustomsConfirm =
              customsConfirmIndex !== -1 &&
              (cells[customsConfirmIndex] || "").trim().length > 0;

            return name.length > 0 && (hasNumber || hasCustomsConfirm);
          });

          if (displayRows.length === 0) {
            showMessage("No verified drivers with assigned numbers yet.");
            return;
          }

          const tableWrapper = document.querySelector(".table-wrapper");
          if (!tableWrapper) {
            console.error("No .table-wrapper element found.");
            return;
          }

          const table = document.createElement("table");

          // Build table head
          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");

          // Driver column
          const nameTh = document.createElement("th");
          nameTh.textContent = "Driver";
          headerRow.appendChild(nameTh);

          // Number columns (only active ones)
          activeSeriesColumns.forEach(col => {
            const th = document.createElement("th");
            th.textContent = col.label;
            headerRow.appendChild(th);
          });

          // Customs confirmation column (if present)
          if (customsConfirmIndex !== -1) {
            const customsConfirmTh = document.createElement("th");
            customsConfirmTh.textContent = "Racing Customs?";
            headerRow.appendChild(customsConfirmTh);
          }

          // Verified column
          if (verifiedIndex !== -1) {
            const verifiedTh = document.createElement("th");
            verifiedTh.textContent = "Verified";
            headerRow.appendChild(verifiedTh);
          }

          thead.appendChild(headerRow);
          table.appendChild(thead);

          // Build table body
          const tbody = document.createElement("tbody");

          displayRows.forEach(cells => {
            const tr = document.createElement("tr");

            // Driver name
            const nameTd = document.createElement("td");
            nameTd.textContent = cells[nameIndex] || "";
            tr.appendChild(nameTd);

            // Numbers
            activeSeriesColumns.forEach(col => {
              const td = document.createElement("td");
              td.textContent = col.index !== -1 ? (cells[col.index] || "") : "";
              tr.appendChild(td);
            });

            // Customs confirmation value
            if (customsConfirmIndex !== -1) {
              const customsTd = document.createElement("td");
              customsTd.textContent = cells[customsConfirmIndex] || "";
              tr.appendChild(customsTd);
            }

            // Verified value
            if (verifiedIndex !== -1) {
              const verifiedTd = document.createElement("td");
              const raw = (cells[verifiedIndex] || "").trim();
              verifiedTd.textContent = raw || "Verified";
              tr.appendChild(verifiedTd);
            }

            tbody.appendChild(tr);
          });

          table.appendChild(tbody);

          tableWrapper.innerHTML = "";
          tableWrapper.appendChild(table);
        } catch (err) {
          console.error("Error loading roster:", err);
          showMessage("There was an error loading the roster. Please try again later.");
        }
      }

      document.addEventListener("DOMContentLoaded", loadRoster);
    </script>
  </body>
</html>
        </p>
        <div class="table-wrapper">
        </div>
      </section>
    </main>
    <footer class="site-footer">
      &copy; 2025 Redline Racing Alliance. This is a fan-made league and is not officially affiliated with NASCAR or any game developer.
    </footer>
  </body>
</html>
