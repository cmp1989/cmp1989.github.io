<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roster – Redline Racing Alliance</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>

    <header class="site-header">
      <div class="brand">
        <img src="rra_logo.png" alt="Redline Racing Alliance logo" class="logo">
        <div class="brand-text">
          <h1>Redline Racing Alliance</h1>
          <p class="tagline">NASCAR ’25 PC Racing League</p>
        </div>
      </div>

      <nav>
        <ul class="nav-list">
          <li><a href="index.html">Home</a></li>
          <li><a href="about.html">About</a></li>
          <li><a href="schedule.html">Schedule</a></li>
          <li><a href="signup.html">Sign&nbsp;Up</a></li>
          <li><a href="roster.html">Roster</a></li>
          <li><a href="teams.html">Teams</a></li>
          <li><a href="rules.html">Rules</a></li>
          <li><a href="standings.html">Standings</a></li>
          <li><a href="contact.html">Contact</a></li>
        </ul>
      </nav>
    </header>
    <main class="content">
      <h2 class="page-title">Driver Roster</h2>
      <section class="card">
        <p>
              <script>
      // 1. Put your published CSV link here:
      const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS3L8lLjAnWpwOB4bXnx-i7XwYYTiYquiTWTmxTepyrP7oUEnEPi1vniKNOLBCU6-8WmTAk0kS7rqOj/pub?gid=685554557&single=true&output=csv";

      function showMessage(msg) {
        const wrapper = document.querySelector(".table-wrapper");
        if (wrapper) {
          wrapper.innerHTML = "<p>" + msg + "</p>";
        }
      }

      // Proper CSV parser that handles quoted fields and commas inside quotes
      function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            // Escaped quote inside quotes ("")
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++; // skip the next quote
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            result.push(current);
            current = "";
          } else {
            current += char;
          }
        }

        result.push(current);
        return result.map(c => c.trim());
      }

      async function loadRoster() {
        try {
          const response = await fetch(SHEET_CSV_URL);
          if (!response.ok) {
            showMessage("Error loading roster data (HTTP " + response.status + ").");
            return;
          }

          const csvText = await response.text();
          const lines = csvText.trim().split(/\r?\n/);

          if (lines.length < 2) {
            showMessage("No registration data found yet.");
            return;
          }

          const parsedRows = lines.map(parseCSVLine);
          const headers = parsedRows[0];
          const rows = parsedRows.slice(1);

          // Find the name column
          const nameIndex = headers.findIndex(h =>
            /steam name/i.test(h) ||
            /in-game tag/i.test(h) ||
            /driver name/i.test(h)
          );

          // Find the Verified column
          const verifiedIndex = headers.findIndex(h =>
            /verified/i.test(h)
          );

          if (nameIndex === -1) {
            showMessage("Roster error: could not find a Driver Name column. Check your sheet headers.");
            console.error("Headers:", headers);
            return;
          }

          // First, figure out which rows are verified
          const allRows = rows;
          const verifiedRows = allRows.filter(cells => {
            if (verifiedIndex === -1) return true; // if no Verified column, show everyone
            const value = (cells[verifiedIndex] || "").trim();
            return value.length > 0;
          });

          if (verifiedRows.length === 0) {
            showMessage("No verified drivers yet. (" + allRows.length + " total registrations found)");
            return;
          }

          // Figure out which columns are "number/series" columns
          // AND actually have at least one value among verified drivers
          const candidateSeriesIndexes = [];
          headers.forEach((h, idx) => {
            if (idx === nameIndex || idx === verifiedIndex) return;
            const lower = h.toLowerCase();
            // Heuristic: number columns have # / "number" / "car" in the header
            if (lower.includes("#") || lower.includes("number") || lower.includes("car")) {
              candidateSeriesIndexes.push(idx);
            }
          });

          const seriesIndexes = candidateSeriesIndexes.filter(idx => {
            return verifiedRows.some(cells => {
              const value = (cells[idx] || "").trim();
              return value.length > 0;
            });
          });

          if (seriesIndexes.length === 0) {
            showMessage("No series numbers chosen yet for verified drivers.");
            return;
          }

          const tableWrapper = document.querySelector(".table-wrapper");
          if (!tableWrapper) {
            console.error("No .table-wrapper element found.");
            return;
          }

          const table = document.createElement("table");

          // Build table head
          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");

          // Driver name column
          const nameTh = document.createElement("th");
          nameTh.textContent = "Driver";
          headerRow.appendChild(nameTh);

          // One column per number/series that actually has data
          seriesIndexes.forEach(idx => {
            const th = document.createElement("th");
            th.textContent = headers[idx]; // you can rename later if you want
            headerRow.appendChild(th);
          });

          // Status / Verified column (optional, but you said you want it)
          if (verifiedIndex !== -1) {
            const statusTh = document.createElement("th");
            statusTh.textContent = "Status";
            headerRow.appendChild(statusTh);
          }

          thead.appendChild(headerRow);
          table.appendChild(thead);

          // Build table body
          const tbody = document.createElement("tbody");

          verifiedRows.forEach(cells => {
            const tr = document.createElement("tr");

            // Driver name
            const nameTd = document.createElement("td");
            nameTd.textContent = cells[nameIndex] || "";
            tr.appendChild(nameTd);

            // Their numbers for each series (some cells may be blank, which is fine)
            seriesIndexes.forEach(idx => {
              const td = document.createElement("td");
              td.textContent = cells[idx] || "";
              tr.appendChild(td);
            });

            // Status (what you put in Verified column)
            if (verifiedIndex !== -1) {
              const statusTd = document.createElement("td");
              const raw = (cells[verifiedIndex] || "").trim();
              statusTd.textContent = raw || "Verified";
              tr.appendChild(statusTd);
            }

            tbody.appendChild(tr);
          });

          table.appendChild(tbody);

          tableWrapper.innerHTML = "";
          tableWrapper.appendChild(table);
        } catch (err) {
          console.error("Error loading roster:", err);
          showMessage("There was an error loading the roster. Please try again later.");
        }
      }

      document.addEventListener("DOMContentLoaded", loadRoster);
    </script>
  </body>
</html>
        </p>
        <div class="table-wrapper">
        </div>
      </section>
    </main>
    <footer class="site-footer">
      &copy; 2025 Redline Racing Alliance. This is a fan-made league and is not officially affiliated with NASCAR or any game developer.
    </footer>
  </body>
</html>
